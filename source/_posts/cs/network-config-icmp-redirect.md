---
title: 網路設定問題：ICMP Redirect 造成斷線
date: 2024-08-28 17:07:22
categories:
tags: route,icmp,icmp-redirect
---

![](network-config.jpg)

網路架構如上圖。

### 網路架構


`H`為主要操作系統，為了正確存取各設備，需設定Routing Table。

很不幸的，網路中有兩個設定相同的網段 192.168.50.0/24，一個姑且稱為Private LAN，用途是存取192.168.50.101這台`A`；
另一個稱為Public LAN, 用於存取192.168.50.0/24上的機器，如`X`，並且也連接Internet。

192.168.50.1 及 192.168.47.254 是各別用來連接 192.168.50.0(Private) 和 192.168.47.0 的AP。

Route Table 設定如下：

| Destination    | Mask | Gateway        | Interface      |
|:---------------|:-----|:---------------|:---------------|
| 0.0.0.0        | /0   | 192.168.47.254 | 192.168.47.173 |
| 192.168.50.0   | /24  | 192.168.47.254 | 192.168.47.173 |
| 192.168.50.101 | /32  | *192.168.50.1* | 192.168.50.165 |

### 網路異常 

看起來沒問題，但有件奇怪的事：**由`H`SSH至`A`大約只要30秒後，就會斷線**。

也不像網路不穩，連接服務時很正常，斷線間隔的時間也相當固定。

經過許多測試後，**只有`H`連至`A`有這問題**，而`H`連到Public LAN上的服務如`X`、或是從其它電腦連至`A`都沒問題。甚致架設於`H`的VM連線至`A`，也是有一樣的問題。

歸納後推測問題應出在`H`上的網路設定上。

### 解決

![](sniffering.jpg)

一開始始著從防火牆下手，包括Windows Definder及防毒軟體設定，但都沒作用。

接著用Wireshark 側錄了封包，發現當`H`SSH至`A`時，Private LAN AP 就會傳送**ICMP Redirect**的封包，

恩，這個意思是什麼呢？

試著在`H`上禁用ICMP Redirect或甚致於防火牆阻擋此封包都沒有用。

但原因似乎就暗示出在route至192.168.50.101的規則上。

再看看Routing Table，終於發現奇怪的地方，於是修改成如下就好了!

| Destination    | Mask | Gateway          | Interface      |
|:---------------|:-----|:-----------------|:---------------|
| 0.0.0.0        | /0   | 192.168.47.254   | 192.168.47.173 |
| 192.168.50.0   | /24  | 192.168.47.254   | 192.168.47.173 |
| 192.168.50.101 | /32  | *192.168.50.165* | 192.168.50.165 |

在設定Route規則時，有個欄位是Gateway；因實際上，`H`確實是透過AP連接至`A`的，所以很容易誤以為Gateway要填AP(192.168.50.1)。然而在網路Topology上，`H`和`A`其實在同一LAN上，所以此欄位應設定為***介面網卡的IP***即可！

指令如下，Gateway Placeholder代入的是`H`的IP，即192.168.50.165：

```batch
CMD> route add 192.168.50.101 mask 255.255.255.255 192.168.50.165
```

在Windows上，會顯示"<font color="red">在連結上</font>"。

最終的Route Table大概長這樣：

```batch
CMD> route print
...
IPv4 路由表
===========================================================================
使用中的路由:
網路目的地                 網路遮罩            閘道          介面       計量
          0.0.0.0          0.0.0.0   192.168.47.254   192.168.47.173     51
     192.168.50.0    255.255.255.0   192.168.47.254   192.168.47.173     51
     192.168.50.1  255.255.255.255          在連結上   192.168.50.165     26
   192.168.50.101  255.255.255.255          在連結上   192.168.50.165     26
```

### 總結

我的理解是，原本的設定比較像是`H`傳給AP，再請AP幫忙Relay給`A`；但其實`H`和`A`在同一個網段上，只需要使用Broadcast就好。所以AP就發出ICMP Redirect，不再幫忙Relay然後就斷線了。

一般其實不太會遇到這個問題，因為在同一個LAN，沒有必要特地去設定Route規則；然而此處卻是個特例，因為有兩個192.168.50.0/24網段，有手動設定的必要，偏偏設錯後，還能正常運作30秒，因而造成這個奇怪的問題。

